# https://taskfile.dev/#/installation
version: '3'

silent: true

vars:
  CONFIG_EXAMPLE_PATH: .testifylint.yml

tasks:
  default:
    cmds:
      - task: tidy
      - task: fmt
      - task: lint
      - task: tests
      - task: install
      - task: config:dump

  tools:install:
    - echo "Install local tools..."
    - (which gci > /dev/null) || go install github.com/daixiang0/gci@latest
    - (which gofumpt > /dev/null) || go install mvdan.cc/gofumpt@latest

  tidy:
    cmds:
      - echo "Tidy..."
      - go mod tidy

  fmt:
    cmds:
      - echo "Fmt..."
      - gofumpt -w .
      - gci write -s standard -s default -s "Prefix(github.com/Antonboom/testifylint)" . 2> /dev/null

  lint:
    cmds:
      - echo "Lint..."
      - golangci-lint run --fix ./...

  tests:
    cmds:
      - echo "Tests..."
      - go test ./...

  tests:coverage:
    cmds:
      - echo "Tests with coverage..."
      - go test -coverpkg ./analyzer,./config,./internal/analysisutil,./internal/checkers -coverprofile=coverage.out ./...

  install:
    cmds:
      - echo "Install..."
      - go install ./... && testifylint -h 2> /dev/null

  config:dump:
    cmds:
      - echo "Dump config..."
      - testifylint -dump-config > {{.CONFIG_EXAMPLE_PATH}}
